name: Build and Deploy to AKS (ARM64)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. æ‹‰å–ç¨‹å¼ç¢¼
    - name: Checkout Code
      uses: actions/checkout@v4

    # 2. ç™»å…¥ Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 3. è¨­ç½® QEMU (è®“ Intel é›»è…¦å¯ä»¥ç·¨è­¯ ARM64)
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    # 4. è¨­ç½® Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 5. Build & Push å‰ç«¯
    - name: Build/Push Frontend
      uses: docker/build-push-action@v5
      with:
        context: "./20260127 Portfolio"
        push: true
        platforms: linux/arm64
        # ğŸ‘‡ æ”¹é€™è£¡ï¼šè®Šæˆ v2.1-<æµæ°´è™Ÿ> (ä¾‹å¦‚ v2.1-45)
        tags: louisvong1/louis-portfolio:v2.1-${{ github.run_number }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # 6. Build & Push å¾Œç«¯
    - name: Build/Push Backend
      uses: docker/build-push-action@v5
      with:
        context: "./microservice/python-app"
        push: true
        platforms: linux/arm64
        # ğŸ‘‡ æ”¹é€™è£¡ï¼šè®Šæˆ v2.0-<æµæ°´è™Ÿ>
        tags: louisvong1/my-counter-app:v2.0-${{ github.run_number }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # 7. ç™»å…¥ Azure
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # 8. é€£ç·šåˆ° AKS
    - name: Set AKS Context
      uses: azure/aks-set-context@v3
      with:
        resource-group: RG-K8S-TEST    # âš ï¸ è«‹ç¢ºèªä½ çš„è³‡æºç¾¤çµ„åç¨±
        cluster-name: K8S-TEST         # âš ï¸ è«‹ç¢ºèªä½ çš„ AKS åç¨±

    # 9. éƒ¨ç½² (å‚³å…¥å‹•æ…‹ Tag)
    - name: Deploy to AKS with Helm
      run: |
        curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash

        # ğŸ‘‡ æ”¹é€™è£¡ï¼šæŠŠå‰›å‰›ç”Ÿæˆçš„æµæ°´è™Ÿ Tag å‚³é€²å»
        helm upgrade --install my-portfolio ./portfolio-chart \
          --namespace default \
          --set frontend.image.tag=v2.1-${{ github.run_number }} \
          --set backend.image.tag=v2.0-${{ github.run_number }} \
          --atomic
        
        kubectl get pods